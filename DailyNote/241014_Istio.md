# Service Mesh - Istio ì„¤ì¹˜ ë° ì•± ë°°í¬
---
# 1. Istio ì„¤ì¹˜

```sh
[root@~] curl -L https://istio.io/downloadIstio | sh -
[root@~] cd istio-1.23.2/
[root@~/istio-1.23.2] export PATH=$PWD/bin:$PATH
[root@~/istio-1.23.2] echo "export PATH=$PWD/bin:$PATH" >> ~/.bashrc
[root@~/istio-1.23.2] istioctl install --set profile=demo
        |\          
        | \         
        |  \        
        |   \       
      /||    \      
     / ||     \     
    /  ||      \    
   /   ||       \   
  /    ||        \  
 /     ||         \ 
/______||__________\
____________________
  \__       _____/  
     \_____/        
Error: check minimum supported Kubernetes version: error getting Kubernetes version: the server has asked for the client to provide credentials


```
## 1.1 issue#1
- msg
	- ì¿ ë²„ë„¤í‹°ìŠ¤ ë²„ì „ ì •ë³´ë¥¼ ì–»ëŠ” ê²ƒì— ì—ëŸ¬ ë°œìƒ
	- í´ëŸ¬ìŠ¤í„° ìœ íš¨ì„± ê²€ì‚¬ ì˜¤ë¥˜
```sh
[root@~/istio-1.23.2] istioctl install --set profile=demo
Error: check minimum supported Kubernetes version: error getting Kubernetes version: the server has asked for the client to provide credentials
```

```sh
[root@~/istio-1.23.2] kops validate cluster
Using cluster from kubectl context: team3cluster.lion.nyhhs.com

Validating cluster team3cluster.lion.nyhhs.com

Error: validation failed: unexpected error during validation: error listing nodes: Unauthorized
```
- ì›ì¸
	- ì ‘ê·¼ ê¶Œí•œì´ ì—†ê¸° ë•Œë¬¸ì— ë²„ì „ ì •ë³´ë¥¼ ì–»ì„ ìˆ˜ ì—†ë‹¤.
	- ì¸ì¦ë°›ì§€ ì•Šì•˜ê¸° ë•Œë¬¸ì—, validationì„ ìˆ˜í–‰í•  ìˆ˜ ì—†ë‹¤.
- í•´ê²°ë°©ë²•
	- kubectl admin ê¶Œí•œì„ ë¶€ì—¬ë°›ê³  ì§„í–‰í•œë‹¤.
```sh
[root@~/istio-1.23.2] kops export kubecfg --admin --name team3cluster.lion.nyhhs.com --state s3://team3cluster.lion2.nyhhs.com
```

- ë‹¤ì‹œ ì„¤ì¹˜
```sh
[root@~/istio-1.23.2] istioctl install --set profile=demo
        |\          
        | \         
        |  \        
        |   \       
      /||    \      
     / ||     \     
    /  ||      \    
   /   ||       \   
  /    ||        \  
 /     ||         \ 
/______||__________\
____________________
  \__       _____/  
     \_____/        

This will install the Istio 1.23.2 "demo" profile (with components: Istio core, Istiod, Ingress gateways, and Egress gateways) into the cluster. Proceed? (y/N) y
This will install the Istio 1.23.2 "demo" profile (with components: Istio core, Istiod, Ingress gateways, and Egress gateways) into the cluster. Proceed? (y/N) y
âœ” Istio core installed â›µï¸
âœ” Istiod installed ğŸ§ 
âœ” Egress gateways installed ğŸ›«
âœ” Ingress gateways installed ğŸ›¬
âœ” Installation complete
Made this installation the default for cluster-wide operations.
```

# 2. namespace ì„¤ì •
## 2.1 ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ìƒì„± ë° ì´ë™
```sh
[root@~/istio-1.23.2] kubectl create ns bookinfo

[root@~/istio-1.23.2] kubens bookinfo
```
## 2.2 ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— ëŒ€í•œ istioì˜ ì ‘ê·¼ í—ˆìš©
```
[root@~/istio-1.23.2] kubectl label namespace bookinfo istio-injection=enalbed
```

# 3. ì˜ˆì œ ì•± ë°°í¬
```sh
[root@~/istio-1.23.2] kubectl apply -f samples/bookinfo/platform/kube/bookinfo.yaml
service/details created
serviceaccount/bookinfo-details created
deployment.apps/details-v1 created
service/ratings created
serviceaccount/bookinfo-ratings created
deployment.apps/ratings-v1 created
service/reviews created
serviceaccount/bookinfo-reviews created
deployment.apps/reviews-v1 created
deployment.apps/reviews-v2 created
deployment.apps/reviews-v3 created
service/productpage created
serviceaccount/bookinfo-productpage created
deployment.apps/productpage-v1 created

# ì˜ˆì œ ì•± í™ˆí˜ì´ì§€ html ì‚½ì…
[root@~/istio-1.23.2/samples/bookinfo/networking] kubectl exec "$(kubectl get pod -l app=ratings -o jsonpath='{.items[0].metadata.name}')" -c ratings -- curl -sS productpage.bookinfo.svc.cluster.local:9080/productpage | grep -o "<title>.*</title>"

# í™•ì¸
[root@~/istio-1.23.2/samples/bookinfo/platform/kube] kubectl get all
```

# 4&5 ì˜ˆì œ ì•± ë°°í¬ëœ NSì— gateway, virtualservice ë°°í¬
- ê²Œì´íŠ¸ì›¨ì´ yaml
```sh
[root@~/istio-1.23.2/samples/bookinfo/networking] vi bookinfo-gateway.yaml
-----------------------------------------
apiVersion: networking.istio.io/v1alpha3
kind: Gateway
metadata:
  name: bookinfo-gateway
spec:
  # The selector matches the ingress gateway pod labels.
  # If you installed Istio using Helm following the standard documentation, this would be "istio=ingress"
  selector:
    istio: ingressgateway # use istio default controller
  servers:
  - port:
      number: 8080
      name: http
      protocol: HTTP
    hosts:
    - "*"
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: bookinfo
spec:
  hosts:
  - "*"
  gateways:
  - bookinfo-gateway
  http:
  - match:
    - uri:
        exact: /productpage
    - uri:
        prefix: /static
    - uri:
        exact: /login
    - uri:
        exact: /logout
    - uri:
        prefix: /api/v1/products
    route:
    - destination:
        host: productpage
        port:
          number: 9080


```
- ê²Œì´íŠ¸ì›¨ì´ ë°°í¬
```sh
[root@~/istio-1.23.2/samples/bookinfo/networking] k apply -f bookinfo-gateway.yaml 
```
- ê²Œì´íŠ¸ì›¨ì´ External IP í™•ì¸
```sh
[root@~/istio-1.23.2/samples/bookinfo/networking] kubectl get svc -n istio-system
istio-ingressgateway   LoadBalancer   100.66.62.155    a8a579153bb1f48dba7633aef16776dd-1581940992.ap-northeast-2.elb.amazonaws.com   15021:30419/TCP,80:30891/TCP,443:31147/TCP,31400:30405/TCP,15443:31392/TCP   33m
```
- ì™¸ë¶€ì—ì„œ ì˜ˆì œ ì•± ì ‘ì†
  : `http://a8a579153bb1f48dba7633aef16776dd-1581940992.ap-northeast-2.elb.amazonaws.com/productpage`

# 6. Kiali Dashboard ë°°í¬
## 6.1 Kiali ë“± addon ë°°í¬
```sh
[root@~/istio-1.23.2] kubectl apply -f samples/addons
```

## 6. 2 ì™¸ë¶€ì—ì„œ kiali ì ‘ì† ê°€ëŠ¥í•˜ë„ë¡ Port-forwarding
```
k port-forward -n istio-system svc/kiali --address 0.0.0.0 5444:20001
```
- ì™¸ë¶€ì—ì„œ ì ‘ì†
  : `http://13.209.176.124:5444/kiali` (Bastion IP)